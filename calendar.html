<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LeadForge ‚Äî Calendar</title>
<link href="https://fonts.googleapis.com/css2?family=Archivo:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://accounts.google.com/gsi/client" async defer></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0a0e14;--bg2:#0d1117;--bg3:#141b24;--bg4:#1a232e;
  --neon:#00ff87;--cyan:#00d4ff;--text:#c5d0dc;--text2:#8899aa;
  --border:#1e2a38;--danger:#ff4757;--warning:#ffa502;--purple:#a855f7;
  --card:#0f1620;--card-hover:#141e2a;
  --radius:10px;--radius-sm:6px;
  --glow-green:0 0 20px rgba(0,255,135,.15);
  --glow-cyan:0 0 20px rgba(0,212,255,.15);
}
html{font-size:15px;scroll-behavior:smooth}
body{font-family:'Archivo',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden}
body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse at 20% 0%,rgba(0,255,135,.04) 0%,transparent 60%),radial-gradient(ellipse at 80% 100%,rgba(0,212,255,.04) 0%,transparent 60%);pointer-events:none;z-index:0}
::selection{background:var(--neon);color:var(--bg)}
input,select,textarea,button{font-family:inherit;font-size:inherit}
::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:var(--bg2)}::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}

/* Header */
.header{position:sticky;top:0;z-index:100;background:var(--bg2);border-bottom:1px solid var(--border);padding:12px 20px;display:flex;align-items:center;gap:12px;backdrop-filter:blur(12px)}
.logo{font-family:'JetBrains Mono',monospace;font-weight:700;font-size:1.1rem;color:var(--neon);letter-spacing:-0.5px;white-space:nowrap;text-shadow:0 0 12px rgba(0,255,135,.3);text-decoration:none;display:flex;align-items:center;gap:8px}
.logo span{color:var(--cyan)}
.logo .sep{color:var(--border);font-weight:400}
.logo .page-name{color:var(--cyan);font-weight:600}
.header-spacer{flex:1}
.btn{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;border:none;border-radius:var(--radius-sm);font-weight:600;font-size:.85rem;cursor:pointer;transition:all .2s;white-space:nowrap}
.btn-primary{background:var(--neon);color:var(--bg);box-shadow:var(--glow-green)}.btn-primary:hover{transform:translateY(-1px);box-shadow:0 0 30px rgba(0,255,135,.3)}
.btn-secondary{background:var(--bg3);color:var(--text);border:1px solid var(--border)}.btn-secondary:hover{border-color:var(--cyan);color:var(--cyan)}
.btn-danger{background:transparent;color:var(--danger);border:1px solid var(--danger)}.btn-danger:hover{background:var(--danger);color:#fff}
.btn-icon{padding:8px 10px;font-size:1rem;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);cursor:pointer;color:var(--text);transition:all .2s}.btn-icon:hover{border-color:var(--neon);color:var(--neon)}
.btn-sm{padding:6px 10px;font-size:.8rem}
.btn-cal{background:rgba(0,212,255,.1);color:var(--cyan);border:1px solid rgba(0,212,255,.3)}.btn-cal:hover{background:rgba(0,212,255,.2);border-color:var(--cyan)}
.btn-ghost{background:transparent;color:var(--text2);border:1px solid transparent;padding:6px 10px}.btn-ghost:hover{color:var(--neon);border-color:var(--border)}

/* Connection banner */
.connect-banner{padding:40px 20px;text-align:center;max-width:420px;margin:80px auto}
.connect-banner .icon{font-size:3.5rem;margin-bottom:16px}
.connect-banner h2{font-size:1.3rem;font-weight:700;margin-bottom:8px}
.connect-banner p{color:var(--text2);font-size:.9rem;margin-bottom:20px;line-height:1.5}

/* Toolbar */
.toolbar{display:flex;align-items:center;gap:12px;padding:16px 20px;flex-wrap:wrap}
.toolbar-nav{display:flex;align-items:center;gap:6px}
.current-period{font-family:'JetBrains Mono',monospace;font-weight:700;font-size:1.15rem;min-width:200px;text-align:center;color:var(--text)}
.view-tabs{display:flex;gap:4px;background:var(--bg3);border-radius:var(--radius-sm);padding:3px;border:1px solid var(--border)}
.view-tab{padding:6px 14px;border-radius:4px;font-size:.8rem;font-weight:600;cursor:pointer;border:none;background:transparent;color:var(--text2);transition:all .2s}
.view-tab.active{background:var(--neon);color:var(--bg)}
.today-count{font-family:'JetBrains Mono',monospace;font-size:.8rem;color:var(--cyan);background:rgba(0,212,255,.1);border:1px solid rgba(0,212,255,.2);padding:4px 10px;border-radius:20px}

/* Month Grid */
.month-grid{padding:0 20px 20px}
.weekday-header{display:grid;grid-template-columns:repeat(7,1fr);gap:1px;margin-bottom:1px}
.weekday-header div{padding:8px;text-align:center;font-size:.7rem;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text2);font-family:'JetBrains Mono',monospace}
.days-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:1px;background:var(--border);border:1px solid var(--border);border-radius:var(--radius)}
.day-cell{background:var(--bg2);min-height:110px;padding:6px;cursor:pointer;transition:all .15s;position:relative;overflow:hidden}
.day-cell:first-child{border-radius:var(--radius) 0 0 0}
.day-cell:nth-child(7){border-radius:0 var(--radius) 0 0}
.day-cell:hover{background:var(--bg3)}
.day-cell.other-month{opacity:.35}
.day-cell.today{background:rgba(0,255,135,.04)}
.day-cell.today .day-num{color:var(--bg);background:var(--neon);border-radius:50%;width:26px;height:26px;display:flex;align-items:center;justify-content:center}
.day-num{font-family:'JetBrains Mono',monospace;font-size:.8rem;font-weight:600;margin-bottom:4px;color:var(--text2);width:26px;height:26px;display:flex;align-items:center;justify-content:center}
.day-event{font-size:.7rem;padding:2px 5px;border-radius:3px;margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;cursor:pointer;transition:all .15s;line-height:1.4}
.day-event:hover{filter:brightness(1.3)}
.day-event.default{background:rgba(0,212,255,.15);color:var(--cyan);border-left:2px solid var(--cyan)}
.day-event.green{background:rgba(0,255,135,.12);color:var(--neon);border-left:2px solid var(--neon)}
.day-event.purple{background:rgba(168,85,247,.12);color:var(--purple);border-left:2px solid var(--purple)}
.day-event.red{background:rgba(255,71,87,.12);color:var(--danger);border-left:2px solid var(--danger)}
.day-event.orange{background:rgba(255,165,2,.12);color:var(--warning);border-left:2px solid var(--warning)}
.day-more{font-size:.65rem;color:var(--text2);padding:1px 5px;cursor:pointer;font-family:'JetBrains Mono',monospace}
.day-more:hover{color:var(--cyan)}

/* Week View */
.week-view{padding:0 20px 20px;overflow-x:auto}
.week-grid{display:grid;grid-template-columns:60px repeat(7,1fr);gap:0;border:1px solid var(--border);border-radius:var(--radius);min-width:700px}
.week-header-row{display:contents}
.week-header-cell{padding:10px 6px;text-align:center;font-size:.75rem;font-weight:600;color:var(--text2);background:var(--bg3);border-bottom:1px solid var(--border);font-family:'JetBrains Mono',monospace}
.week-header-cell:first-child{border-radius:var(--radius) 0 0 0}
.week-header-cell:last-child{border-radius:0 var(--radius) 0 0}
.week-header-cell.today-col{color:var(--neon)}
.week-header-cell .day-number{font-size:1.1rem;font-weight:700;display:block;margin-top:2px}
.week-time-col{font-family:'JetBrains Mono',monospace;font-size:.65rem;color:var(--text2);padding:0 6px;text-align:right;background:var(--bg2);border-right:1px solid var(--border);height:48px;display:flex;align-items:flex-start;justify-content:flex-end;padding-top:2px}
.week-slot{background:var(--bg2);border-right:1px solid var(--border);border-bottom:1px solid rgba(30,42,56,.5);height:48px;position:relative;cursor:pointer;transition:background .15s}
.week-slot:hover{background:var(--bg3)}
.week-slot.hour-line{border-bottom:1px solid var(--border)}
.week-event-block{position:absolute;left:2px;right:2px;border-radius:4px;padding:3px 5px;font-size:.7rem;font-weight:500;overflow:hidden;z-index:2;cursor:pointer;transition:filter .15s;line-height:1.3}
.week-event-block:hover{filter:brightness(1.3);z-index:3}
.week-event-block.default{background:rgba(0,212,255,.2);color:var(--cyan);border-left:2px solid var(--cyan)}
.week-event-block.green{background:rgba(0,255,135,.15);color:var(--neon);border-left:2px solid var(--neon)}
.week-event-block.purple{background:rgba(168,85,247,.15);color:var(--purple);border-left:2px solid var(--purple)}
.week-event-block.red{background:rgba(255,71,87,.15);color:var(--danger);border-left:2px solid var(--danger)}
.week-event-block .ev-time{font-family:'JetBrains Mono',monospace;font-size:.6rem;opacity:.7}

/* Day View */
.day-view{padding:0 20px 20px;max-width:800px;margin:0 auto}
.day-grid{border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}
.day-all-day{background:var(--bg3);padding:8px 12px;border-bottom:1px solid var(--border);font-size:.8rem;color:var(--text2);min-height:36px}
.day-time-row{display:grid;grid-template-columns:60px 1fr;height:48px;border-bottom:1px solid rgba(30,42,56,.4)}
.day-time-row.hour-line{border-bottom:1px solid var(--border)}
.day-time-label{font-family:'JetBrains Mono',monospace;font-size:.65rem;color:var(--text2);padding:2px 8px 0 0;text-align:right;background:var(--bg2);border-right:1px solid var(--border)}
.day-time-slot{position:relative;background:var(--bg2);cursor:pointer;transition:background .15s}
.day-time-slot:hover{background:var(--bg3)}
.day-event-block{position:absolute;left:4px;right:4px;border-radius:4px;padding:4px 8px;font-size:.8rem;font-weight:500;overflow:hidden;z-index:2;cursor:pointer;line-height:1.4}
.day-event-block.default{background:rgba(0,212,255,.2);color:var(--cyan);border-left:3px solid var(--cyan)}
.day-event-block.green{background:rgba(0,255,135,.15);color:var(--neon);border-left:3px solid var(--neon)}
.day-event-block.purple{background:rgba(168,85,247,.15);color:var(--purple);border-left:3px solid var(--purple)}
.day-event-block .ev-title{font-weight:600}.day-event-block .ev-time{font-family:'JetBrains Mono',monospace;font-size:.7rem;opacity:.7}

/* Event Detail Popup */
.event-popup{position:fixed;z-index:300;background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:16px;min-width:280px;max-width:360px;box-shadow:0 8px 32px rgba(0,0,0,.6);display:none}
.event-popup.show{display:block;animation:fadeUp .2s ease}
.event-popup .ep-title{font-size:1rem;font-weight:700;margin-bottom:8px}
.event-popup .ep-time{font-family:'JetBrains Mono',monospace;font-size:.8rem;color:var(--cyan);margin-bottom:6px;display:flex;align-items:center;gap:6px}
.event-popup .ep-loc{font-size:.8rem;color:var(--text2);margin-bottom:6px;display:flex;align-items:center;gap:6px}
.event-popup .ep-desc{font-size:.8rem;color:var(--text);line-height:1.5;margin-bottom:10px;max-height:100px;overflow-y:auto;white-space:pre-wrap}
.event-popup .ep-link{font-size:.8rem;color:var(--cyan);display:inline-flex;align-items:center;gap:4px}
.event-popup .ep-close{position:absolute;top:8px;right:10px;background:none;border:none;color:var(--text2);cursor:pointer;font-size:1.1rem}.event-popup .ep-close:hover{color:var(--text)}

/* Create Event Modal */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:200;display:flex;align-items:center;justify-content:center;padding:20px;opacity:0;visibility:hidden;transition:all .25s}.modal-overlay.show{opacity:1;visibility:visible}
.modal{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);width:100%;max-width:480px;max-height:85vh;overflow-y:auto;transform:translateY(20px);transition:transform .25s;box-shadow:0 8px 40px rgba(0,0,0,.5)}.modal-overlay.show .modal{transform:translateY(0)}
.modal-header{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid var(--border)}.modal-title{font-weight:700;font-size:1.05rem}
.modal-close{background:none;border:none;color:var(--text2);font-size:1.3rem;cursor:pointer}.modal-close:hover{color:var(--text)}
.modal-body{padding:20px}.form-group{margin-bottom:14px}
.form-label{display:block;font-size:.8rem;font-weight:600;color:var(--text2);margin-bottom:4px;text-transform:uppercase;letter-spacing:.3px}.form-label .req{color:var(--danger)}
.form-input,.form-textarea{width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);padding:10px 12px;color:var(--text);font-size:.9rem;transition:border-color .2s}
.form-input:focus,.form-textarea:focus{outline:none;border-color:var(--neon)}.form-textarea{resize:vertical;min-height:60px}
.modal-actions{display:flex;gap:8px;justify-content:flex-end;padding:16px 20px;border-top:1px solid var(--border)}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}

/* Loading */
.loading{display:flex;align-items:center;justify-content:center;padding:60px;color:var(--text2);font-size:.9rem;gap:8px}
@keyframes spin{to{transform:rotate(360deg)}}
.spinner{width:18px;height:18px;border:2px solid var(--border);border-top-color:var(--neon);border-radius:50%;animation:spin .6s linear infinite}
@keyframes fadeUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

/* Responsive */
@media(max-width:800px){
  .header{flex-wrap:wrap;gap:8px;padding:10px 12px}
  .toolbar{flex-wrap:wrap;gap:8px;padding:12px}
  .current-period{min-width:auto;font-size:1rem}
  .day-cell{min-height:70px}
  .day-event{font-size:.6rem}
  .day-cell .day-num{font-size:.7rem}
  .week-view{padding:0 8px 16px}
}
</style>
</head>
<body>

<div class="header">
  <a class="logo" href="index.html">Lead<span>Forge</span> <span class="sep">/</span> <span class="page-name">Calendar</span></a>
  <div class="header-spacer"></div>
  <span class="today-count" id="todayCount"></span>
  <button class="btn btn-primary" onclick="openCreateEvent()">+ Event</button>
</div>

<div id="connectBanner" class="connect-banner" style="display:none">
  <div class="icon">üìÖ</div>
  <h2>Connect Google Calendar</h2>
  <p>Sign in with your Google account to see your calendar events, create appointments, and stay synced.</p>
  <button class="btn btn-primary" onclick="handleCalAuth()" id="connectBtn">üîó Connect Google Calendar</button>
</div>

<div id="calApp" style="display:none">
  <div class="toolbar">
    <div class="toolbar-nav">
      <button class="btn-ghost" onclick="navPrev()">‚óÄ</button>
      <button class="btn btn-sm btn-secondary" onclick="goToday()">Today</button>
      <button class="btn-ghost" onclick="navNext()">‚ñ∂</button>
    </div>
    <div class="current-period" id="currentPeriod"></div>
    <div class="header-spacer"></div>
    <div class="view-tabs">
      <button class="view-tab active" id="tabMonth" onclick="setView('month')">Month</button>
      <button class="view-tab" id="tabWeek" onclick="setView('week')">Week</button>
      <button class="view-tab" id="tabDay" onclick="setView('day')">Day</button>
    </div>
  </div>
  <div id="calendarContainer"></div>
</div>

<!-- Event Detail Popup -->
<div class="event-popup" id="eventPopup">
  <button class="ep-close" onclick="closePopup()">√ó</button>
  <div class="ep-title" id="epTitle"></div>
  <div class="ep-time" id="epTime"></div>
  <div class="ep-loc" id="epLoc"></div>
  <div class="ep-desc" id="epDesc"></div>
  <a class="ep-link" id="epLink" href="#" target="_blank">Open in Google Calendar ‚Üí</a>
</div>

<!-- Create Event Modal -->
<div class="modal-overlay" id="createModal">
  <div class="modal">
    <div class="modal-header"><div class="modal-title">üìÖ New Event</div><button class="modal-close" onclick="closeModal()">√ó</button></div>
    <div class="modal-body">
      <div class="form-group"><label class="form-label">Title <span class="req">*</span></label><input class="form-input" id="evTitle" placeholder="Event title"></div>
      <div class="form-group"><label class="form-label">Date <span class="req">*</span></label><input class="form-input" id="evDate" type="date"></div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Start <span class="req">*</span></label><input class="form-input" id="evStart" type="time" value="09:00"></div>
        <div class="form-group"><label class="form-label">End <span class="req">*</span></label><input class="form-input" id="evEnd" type="time" value="10:00"></div>
      </div>
      <div class="form-group"><label class="form-label">Location</label><input class="form-input" id="evLocation" placeholder="Office, Zoom, etc."></div>
      <div class="form-group"><label class="form-label">Description</label><textarea class="form-textarea" id="evDesc" placeholder="Details..."></textarea></div>
    </div>
    <div class="modal-actions"><button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" id="createBtn" onclick="createEvent()">üìÖ Create Event</button></div>
  </div>
</div>

<script>
// ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ
const CLIENT_ID='842996070751-qnigld1n1t8stribv4lrhks1hs8b1i88.apps.googleusercontent.com';
const SCOPES='https://www.googleapis.com/auth/calendar.events https://www.googleapis.com/auth/calendar.readonly';
const API='https://www.googleapis.com/calendar/v3';

let token=null,tokenClient=null;
let currentView='month';
let viewDate=new Date();
let allEvents=[];
let eventCache={};

// ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ
function initAuth(){
  token=sessionStorage.getItem('gcal_token');
  if(token){onConnected();return}
  showBanner();
  waitForGIS();
}

function waitForGIS(){
  const ck=setInterval(()=>{
    if(typeof google!=='undefined'&&google.accounts?.oauth2){
      clearInterval(ck);
      tokenClient=google.accounts.oauth2.initTokenClient({
        client_id:CLIENT_ID,scope:SCOPES,
        callback:r=>{if(r.access_token){token=r.access_token;sessionStorage.setItem('gcal_token',token);onConnected()}},
        error_callback:e=>console.error('Auth error:',e)
      });
    }
  },300);
}

function handleCalAuth(){
  if(tokenClient)tokenClient.requestAccessToken();
}

function showBanner(){document.getElementById('connectBanner').style.display='block';document.getElementById('calApp').style.display='none'}

function onConnected(){
  document.getElementById('connectBanner').style.display='none';
  document.getElementById('calApp').style.display='block';
  renderView();
}

async function apiFetch(url,opts={}){
  if(!token)return null;
  const r=await fetch(url,{...opts,headers:{'Authorization':'Bearer '+token,'Content-Type':'application/json',...(opts.headers||{})}});
  if(r.status===401){token=null;sessionStorage.removeItem('gcal_token');showBanner();return null}
  return r.json();
}

// ‚îÄ‚îÄ EVENTS FETCH ‚îÄ‚îÄ
async function fetchEvents(timeMin,timeMax){
  const key=timeMin+':'+timeMax;
  if(eventCache[key])return eventCache[key];

  const url=`${API}/calendars/primary/events?timeMin=${encodeURIComponent(timeMin)}&timeMax=${encodeURIComponent(timeMax)}&singleEvents=true&orderBy=startTime&maxResults=250`;
  const data=await apiFetch(url);
  if(!data?.items)return[];
  eventCache[key]=data.items;
  allEvents=data.items;
  return data.items;
}

function getEventColor(ev){
  const colorId=ev.colorId||'0';
  const map={'1':'default','2':'green','3':'purple','4':'red','5':'orange','6':'default','7':'cyan','8':'default','9':'purple','10':'green','11':'red','0':'default'};
  return map[colorId]||'default';
}

function getEventTimeRange(ev){
  if(!ev.start.dateTime)return{allDay:true,start:new Date(ev.start.date),end:new Date(ev.end.date)};
  return{allDay:false,start:new Date(ev.start.dateTime),end:new Date(ev.end.dateTime)};
}

// ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ
function navPrev(){
  if(currentView==='month')viewDate.setMonth(viewDate.getMonth()-1);
  else if(currentView==='week')viewDate.setDate(viewDate.getDate()-7);
  else viewDate.setDate(viewDate.getDate()-1);
  renderView();
}
function navNext(){
  if(currentView==='month')viewDate.setMonth(viewDate.getMonth()+1);
  else if(currentView==='week')viewDate.setDate(viewDate.getDate()+7);
  else viewDate.setDate(viewDate.getDate()+1);
  renderView();
}
function goToday(){viewDate=new Date();renderView()}
function setView(v){
  currentView=v;
  document.querySelectorAll('.view-tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('tab'+v.charAt(0).toUpperCase()+v.slice(1)).classList.add('active');
  renderView();
}

// ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ
async function renderView(){
  const c=document.getElementById('calendarContainer');
  c.innerHTML='<div class="loading"><div class="spinner"></div>Loading events...</div>';
  updatePeriodLabel();

  if(currentView==='month')await renderMonth(c);
  else if(currentView==='week')await renderWeek(c);
  else await renderDay(c);

  updateTodayCount();
}

function updatePeriodLabel(){
  const el=document.getElementById('currentPeriod');
  if(currentView==='month')el.textContent=viewDate.toLocaleDateString('en-US',{month:'long',year:'numeric'});
  else if(currentView==='week'){
    const start=getWeekStart(viewDate),end=new Date(start);end.setDate(end.getDate()+6);
    el.textContent=`${start.toLocaleDateString('en-US',{month:'short',day:'numeric'})} ‚Äî ${end.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'})}`;
  }else el.textContent=viewDate.toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric',year:'numeric'});
}

function updateTodayCount(){
  const today=new Date();today.setHours(0,0,0,0);
  const tomorrow=new Date(today);tomorrow.setDate(tomorrow.getDate()+1);
  const count=allEvents.filter(ev=>{const t=getEventTimeRange(ev);return t.start<tomorrow&&t.end>today}).length;
  document.getElementById('todayCount').textContent=count+' today';
}

// ‚îÄ‚îÄ MONTH VIEW ‚îÄ‚îÄ
async function renderMonth(container){
  const y=viewDate.getFullYear(),m=viewDate.getMonth();
  const first=new Date(y,m,1),last=new Date(y,m+1,0);
  const startDay=first.getDay()||7; // Monday=1
  const calStart=new Date(first);calStart.setDate(calStart.getDate()-(startDay-1));
  const calEnd=new Date(calStart);calEnd.setDate(calEnd.getDate()+42);

  const events=await fetchEvents(calStart.toISOString(),calEnd.toISOString());

  let html='<div class="month-grid"><div class="weekday-header"><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div><div>Sun</div></div><div class="days-grid">';

  const today=new Date();today.setHours(0,0,0,0);

  for(let i=0;i<42;i++){
    const d=new Date(calStart);d.setDate(d.getDate()+i);
    const isOther=d.getMonth()!==m;
    const isToday=d.getTime()===today.getTime();
    const dayStr=d.toISOString().split('T')[0];

    const dayEvents=events.filter(ev=>{
      const t=getEventTimeRange(ev);
      const evDay=t.allDay?t.start.toISOString().split('T')[0]:new Date(t.start).toLocaleDateString('en-CA');
      return evDay===dayStr;
    });

    html+=`<div class="day-cell${isOther?' other-month':''}${isToday?' today':''}" onclick="onDayClick('${dayStr}')">`;
    html+=`<div class="day-num">${d.getDate()}</div>`;

    const maxShow=3;
    dayEvents.slice(0,maxShow).forEach(ev=>{
      const t=getEventTimeRange(ev);
      const timeStr=t.allDay?'':new Date(t.start).toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit',hour12:true});
      const color=getEventColor(ev);
      html+=`<div class="day-event ${color}" onclick="event.stopPropagation();showEventPopup(event,'${ev.id}')" title="${esc(ev.summary||'')}">${timeStr?'<span style="opacity:.7">'+timeStr+'</span> ':''}${esc((ev.summary||'Event').substring(0,20))}</div>`;
    });
    if(dayEvents.length>maxShow)html+=`<div class="day-more">+${dayEvents.length-maxShow} more</div>`;
    html+='</div>';
  }
  html+='</div></div>';
  container.innerHTML=html;
}

// ‚îÄ‚îÄ WEEK VIEW ‚îÄ‚îÄ
async function renderWeek(container){
  const ws=getWeekStart(viewDate),we=new Date(ws);we.setDate(we.getDate()+7);
  const events=await fetchEvents(ws.toISOString(),we.toISOString());
  const today=new Date();today.setHours(0,0,0,0);

  let html='<div class="week-view"><div class="week-grid"><div class="week-header-row"><div class="week-header-cell"></div>';
  for(let i=0;i<7;i++){
    const d=new Date(ws);d.setDate(d.getDate()+i);
    const isToday=d.getTime()===today.getTime();
    html+=`<div class="week-header-cell${isToday?' today-col':''}">${d.toLocaleDateString('en-US',{weekday:'short'})}<span class="day-number">${d.getDate()}</span></div>`;
  }
  html+='</div>';

  for(let h=0;h<24;h++){
    const label=h===0?'12 AM':h<12?h+' AM':h===12?'12 PM':(h-12)+' PM';
    html+=`<div class="week-time-col${h%1===0?' hour-line':''}">${label}</div>`;
    for(let d=0;d<7;d++){
      html+=`<div class="week-slot hour-line" data-day="${d}" data-hour="${h}" onclick="onSlotClick(${d},${h})"></div>`;
    }
  }
  html+='</div></div>';
  container.innerHTML=html;

  // Place events
  events.forEach(ev=>{
    const t=getEventTimeRange(ev);
    if(t.allDay)return;
    const dayIdx=Math.floor((t.start-ws)/(864e5));
    if(dayIdx<0||dayIdx>6)return;

    const startMin=t.start.getHours()*60+t.start.getMinutes();
    const endMin=t.end.getHours()*60+t.end.getMinutes();
    const duration=Math.max(endMin-startMin,15);

    const top=(startMin/60)*48;
    const height=Math.max((duration/60)*48,20);
    const color=getEventColor(ev);
    const timeStr=t.start.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit',hour12:true});

    // Find the slot column
    const slots=container.querySelectorAll(`.week-slot[data-day="${dayIdx}"][data-hour="${t.start.getHours()}"]`);
    if(slots.length){
      const parent=slots[0].closest('.week-grid');
      // Use absolute positioning relative to the grid
      const block=document.createElement('div');
      block.className='week-event-block '+color;
      block.style.cssText=`top:${top+38}px;height:${height}px;grid-column:${dayIdx+2};position:absolute;`;
      block.innerHTML=`<div style="font-weight:600">${esc((ev.summary||'Event').substring(0,25))}</div><div class="ev-time">${timeStr}</div>`;
      block.onclick=(e)=>{e.stopPropagation();showEventPopup(e,ev.id)};
      parent.style.position='relative';
      parent.appendChild(block);
    }
  });
}

// ‚îÄ‚îÄ DAY VIEW ‚îÄ‚îÄ
async function renderDay(container){
  const ds=new Date(viewDate);ds.setHours(0,0,0,0);
  const de=new Date(ds);de.setDate(de.getDate()+1);
  const events=await fetchEvents(ds.toISOString(),de.toISOString());

  const allDay=events.filter(ev=>getEventTimeRange(ev).allDay);
  const timed=events.filter(ev=>!getEventTimeRange(ev).allDay);

  let html='<div class="day-view"><div class="day-grid">';
  html+=`<div class="day-all-day">${allDay.length?allDay.map(ev=>`<span class="day-event default" onclick="showEventPopup(event,'${ev.id}')">${esc(ev.summary||'Event')}</span>`).join(' '):'<span style="opacity:.4">No all-day events</span>'}</div>`;

  for(let h=0;h<24;h++){
    const label=h===0?'12 AM':h<12?h+' AM':h===12?'12 PM':(h-12)+' PM';
    html+=`<div class="day-time-row${h%1===0?' hour-line':''}"><div class="day-time-label">${label}</div><div class="day-time-slot" data-hour="${h}" onclick="onDaySlotClick(${h})">`;

    timed.forEach(ev=>{
      const t=getEventTimeRange(ev);
      if(t.start.getHours()===h){
        const startMin=t.start.getHours()*60+t.start.getMinutes();
        const endMin=t.end.getHours()*60+t.end.getMinutes();
        const dur=Math.max(endMin-startMin,15);
        const topOff=(t.start.getMinutes()/60)*48;
        const height=Math.max((dur/60)*48,24);
        const color=getEventColor(ev);
        const timeStr=t.start.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit',hour12:true})+' ‚Äî '+t.end.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit',hour12:true});
        html+=`<div class="day-event-block ${color}" style="top:${topOff}px;height:${height}px" onclick="event.stopPropagation();showEventPopup(event,'${ev.id}')"><div class="ev-title">${esc((ev.summary||'Event').substring(0,40))}</div><div class="ev-time">${timeStr}</div></div>`;
      }
    });
    html+='</div></div>';
  }
  html+='</div></div>';
  container.innerHTML=html;
}

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ
function getWeekStart(d){const r=new Date(d);const day=r.getDay()||7;r.setDate(r.getDate()-(day-1));r.setHours(0,0,0,0);return r}
function esc(s){if(!s)return'';const d=document.createElement('div');d.textContent=s;return d.innerHTML}

function onDayClick(dateStr){viewDate=new Date(dateStr+'T12:00:00');setView('day')}
function onSlotClick(dayIdx,hour){
  const ws=getWeekStart(viewDate);
  const d=new Date(ws);d.setDate(d.getDate()+dayIdx);
  const dateStr=d.toISOString().split('T')[0];
  const h=String(hour).padStart(2,'0');
  document.getElementById('evDate').value=dateStr;
  document.getElementById('evStart').value=h+':00';
  document.getElementById('evEnd').value=String(hour+1).padStart(2,'0')+':00';
  document.getElementById('evTitle').value='';
  document.getElementById('evLocation').value='';
  document.getElementById('evDesc').value='';
  openModal2();
}
function onDaySlotClick(hour){
  document.getElementById('evDate').value=viewDate.toISOString().split('T')[0];
  document.getElementById('evStart').value=String(hour).padStart(2,'0')+':00';
  document.getElementById('evEnd').value=String(Math.min(hour+1,23)).padStart(2,'0')+':00';
  document.getElementById('evTitle').value='';
  document.getElementById('evLocation').value='';
  document.getElementById('evDesc').value='';
  openModal2();
}

// ‚îÄ‚îÄ EVENT POPUP ‚îÄ‚îÄ
function showEventPopup(e,eventId){
  const ev=allEvents.find(x=>x.id===eventId);
  if(!ev)return;
  const popup=document.getElementById('eventPopup');
  const t=getEventTimeRange(ev);

  document.getElementById('epTitle').textContent=ev.summary||'No title';

  if(t.allDay){
    document.getElementById('epTime').innerHTML='üìÖ All day ‚Äî '+t.start.toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'});
  }else{
    document.getElementById('epTime').innerHTML='üïê '+t.start.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'})+' ¬∑ '+t.start.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:true})+' ‚Äî '+t.end.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:true});
  }

  const locEl=document.getElementById('epLoc');
  if(ev.location){locEl.innerHTML='üìç '+esc(ev.location);locEl.style.display='flex'}else locEl.style.display='none';

  const descEl=document.getElementById('epDesc');
  if(ev.description){descEl.textContent=ev.description;descEl.style.display='block'}else descEl.style.display='none';

  document.getElementById('epLink').href=ev.htmlLink||'#';

  // Position near click
  const rect=e.target.getBoundingClientRect();
  popup.style.top=Math.min(rect.bottom+8,window.innerHeight-300)+'px';
  popup.style.left=Math.min(rect.left,window.innerWidth-360)+'px';
  popup.classList.add('show');
}

function closePopup(){document.getElementById('eventPopup').classList.remove('show')}
document.addEventListener('click',e=>{if(!e.target.closest('.event-popup')&&!e.target.closest('.day-event')&&!e.target.closest('.week-event-block')&&!e.target.closest('.day-event-block'))closePopup()});

// ‚îÄ‚îÄ CREATE EVENT ‚îÄ‚îÄ
function openCreateEvent(){
  if(!token){handleCalAuth();return}
  document.getElementById('evTitle').value='';
  document.getElementById('evDate').value=viewDate.toISOString().split('T')[0];
  document.getElementById('evStart').value='09:00';
  document.getElementById('evEnd').value='10:00';
  document.getElementById('evLocation').value='';
  document.getElementById('evDesc').value='';
  openModal2();
}
function openModal2(){document.getElementById('createModal').classList.add('show')}
function closeModal(){document.getElementById('createModal').classList.remove('show')}
document.getElementById('createModal').addEventListener('click',e=>{if(e.target===document.getElementById('createModal'))closeModal()});

async function createEvent(){
  const title=document.getElementById('evTitle').value.trim();
  const date=document.getElementById('evDate').value;
  const st=document.getElementById('evStart').value;
  const et=document.getElementById('evEnd').value;
  if(!title||!date||!st||!et){alert('Fill in all required fields');return}

  const btn=document.getElementById('createBtn');
  btn.textContent='‚è≥ Creating...';btn.disabled=true;
  const tz=Intl.DateTimeFormat().resolvedOptions().timeZone;

  try{
    const data=await apiFetch(`${API}/calendars/primary/events`,{method:'POST',body:JSON.stringify({
      summary:title,
      description:document.getElementById('evDesc').value.trim(),
      location:document.getElementById('evLocation').value.trim(),
      start:{dateTime:`${date}T${st}:00`,timeZone:tz},
      end:{dateTime:`${date}T${et}:00`,timeZone:tz},
      reminders:{useDefault:true}
    })});
    if(data?.id){closeModal();eventCache={};renderView();alert('‚úÖ Event created!')}
    else alert('Failed to create event');
  }catch(err){alert('Error: '+err.message)}
  btn.textContent='üìÖ Create Event';btn.disabled=false;
}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
initAuth();
</script>
</body>
</html>
